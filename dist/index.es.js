import e,{useRef as t,useState as r,useCallback as n,useLayoutEffect as c}from"react";const i=e=>{const t=e.getElementsByTagName("br");for(let e=0;e<t.length;e++)t[e].parentNode.removeChild(t[e])},l=(e,t)=>{const r=window.getSelection().anchorNode,n=(e=>{let t=0;if(window.getSelection){var r=window.getSelection().getRangeAt(0),n=r.cloneRange();n.selectNodeContents(e),n.setEnd(r.endContainer,r.endOffset),t=n.toString().length}else if(document.selection&&"Control"!==document.selection.type){var c=document.selection.createRange(),i=document.body.createTextRange();i.moveToElementText(e),i.setEndPoint("EndToEnd",c),t=i.text.length}return t})(e);let c,i=0;for(let t=0;t<e.childNodes.length&&e.childNodes[t]!==r;t++)e.childNodes[t].innerText?i+=e.childNodes[t].innerText.length:i+=e.childNodes[t].nodeValue.length;if(r===e||i===n)return void(0===n&&e.firstChild?e.insertBefore(t,e.firstChild):e.appendChild(t));c=e.firstChild===r?n:n-i;const l=document.createTextNode(r.nodeValue.substring(0,c)),a=document.createTextNode(r.nodeValue.substring(c)),o=r.nextSibling;e.removeChild(r),o?(e.insertBefore(a,o),e.insertBefore(t,a),e.insertBefore(l,t)):(e.appendChild(l),e.appendChild(t),e.appendChild(a))},a=(e,t)=>{t.parentNode.insertBefore(e,t.nextSibling)};!function(e,t){void 0===t&&(t={});var r=t.insertAt;if(e&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],c=document.createElement("style");c.type="text/css","top"===r&&n.firstChild?n.insertBefore(c,n.firstChild):n.appendChild(c),c.styleSheet?c.styleSheet.cssText=e:c.appendChild(document.createTextNode(e))}}("react-taggable-field-container{position:relative}.react-taggable-highlight{color:blue}.react-taggable-field-input{align-items:center;border:1px solid #ccc;border-radius:5px;display:block;min-height:1rem;padding:.4rem;text-align:left;white-space:nowrap;width:100%}.react-taggable-field-suggested-tags{background-color:#fff;border:1px solid #ccc;border-radius:5px;display:grid;min-width:300px;position:absolute;text-align:left;width:fit-content;z-index:1}.react-taggable-field-suggested-tag{cursor:pointer;padding:8px}.react-taggable-field-suggested-tag:hover{background:#f2f2f2}.react-taggable-field-input-tag{background:#333;border-radius:5px;color:#fff;display:inline-block;padding:0 5px}");function o({tags:o,onChange:d,autoFocus:s=!1,defaultValue:u,disabled:g=!1,inputClass:f,suggestionClass:h,onSubmit:m}){const p=t(),b=t(!1),x=t(null),v=t(),y=t([]),[N,T]=r(!1),[C,E]=r([]),k=o.map((e=>e.triggerSymbol)),w=t([]),S=o.reduce(((e,t)=>(e[t.triggerSymbol]={...t},e)),{}),B=t([]),L=e=>{const t=window.getSelection(),r=e||t.anchorNode;r&&t.collapse(r,r.childNodes.length)},A=()=>{const e=((e,t)=>{const r=e.childNodes.length-1;let n;for(let c=0;c<=r;c++){const r=e.childNodes[c];if("#text"!==r.nodeName&&(n=r),r===t)break}return n})(p.current);null!=e&&e.scrollIntoView&&e.scrollIntoView()},M=n((()=>{const e=p.current.getElementsByClassName("react-taggable-field-input-tag");y.current=[];for(let t=0;t<e.length;t++){let r=e[t].getAttribute("data-trigger"),n=S[r].suggestions.find((r=>r.label===e[t].innerText));y.current.push({...n,triggerSymbol:e[t].getAttribute("data-trigger")})}}),[S]),V=n((e=>{var t;const r=["react-taggable-field-input-tag"],n=null===(t=S[v.current])||void 0===t?void 0:t.tagClass;n&&r.push(n),e.tagClass&&r.push(e.tagClass);const c=document.createElement("span");c.className=r.join(" "),c.contentEditable=!1,c.setAttribute("data-trigger",v.current),c.innerText=e.label,b.current=!1,a(c,x.current);const i=document.createTextNode("â€‹");a(i,c),p.current.removeChild(x.current),x.current=null,T(!1),A(),L(i),M()}),[M,S]);return c((()=>{g&&(p.current.setAttribute("contenteditable",!1),p.current.style.opacity=.5)}),[g]),c((()=>{void 0!==u&&(p.current.innerHTML=u)}),[u]),c((()=>{const e=e=>{if(w.current=w.current.filter((t=>t!==e.key)),M(),"Tab"===e.key||" "===e.key||"Enter"===e.key){var t;const r=(null===(t=((e,t)=>{if(!t)return e.childNodes[e.childNodes.length-1];const r=e.childNodes.length-1;let n;for(let c=0;c<=r&&(n=e.childNodes[c],n!==t);c++);return n})(p.current).innerText)||void 0===t?void 0:t.replace(v.current,"").toLowerCase())||"";if(1===B.current.length&&b.current||B.current.includes(r)){const e=1===B.current.length?B.current[0]:r;V(e)}else b.current&&0===B.current.length?((()=>{const e=document.createTextNode(x.current.innerText);a(e,x.current),p.current.removeChild(x.current),x.current=null,b.current=!1,T(!1)})(),L(p.current)):"Enter"===e.key&&m({text:p.current.innerText,__html:p.current.innerHTML,tags:y.current},(()=>{p.current.innerHTML="",y.current=[]}))}if(b.current&&e.key!==v.current){const e=x.current.innerText,t=e.lastIndexOf(v.current),r=e.substr(t+1).replace(/[^\w]/,""),n=new RegExp(r,"i");B.current=S[v.current].suggestions.filter((e=>n.test(e.label))),E(B.current)}d({text:p.current.innerText,__html:p.current.innerHTML,tags:y.current})},t=e=>{if(i(p.current),"Enter"!==e.key&&"Tab"!==e.key||e.preventDefault(),"Backspace"===e.key){var t;if("Meta"===w.current.slice(-1)[0])return y.current=[],p.current.innerHTML="",b.current=!1,void T(!1);b.current&&1===(null===(t=x.current)||void 0===t?void 0:t.innerText.length)&&(x.current=null,b.current=!1,T(!1))}else if(k.includes(e.key)){if(b.current)return void e.preventDefault();v.current=e.key,E(o.find((t=>t.triggerSymbol===e.key)).suggestions),i(p.current),b.current=!0,x.current=document.createElement("span"),x.current.className=`react-taggable-field-highlight ${o.find((e=>e.triggerSymbol===v.current)).highlightClass}`,x.current.innerText=v.current,x.current.setAttribute("contentEditable",!0),l(p.current,x.current),T(!0),L(x.current),A(),e.preventDefault()}w.current.push(e.key)};return document.addEventListener("keydown",t),document.addEventListener("keyup",e),()=>{document.removeEventListener("keydown",t),document.removeEventListener("keyup",e)}}),[V,M,o,k,d,S,m]),e.createElement("div",{className:"react-taggable-field"},e.createElement("div",{className:"react-taggable-field-container"},e.createElement("div",{className:`react-taggable-field-input ${f}`,ref:p,contentEditable:!0})),N&&e.createElement("div",{className:`react-taggable-field-suggested-tags ${h}`},C.map((t=>e.createElement("div",{onClick:()=>V(t),key:t.label,className:"react-taggable-field-suggested-tag"},t.label)))))}export{o as default};
